#jinja2:trim_bl/cks: "true", lstrip_blocks: "true"
{% set subscription = smiths_config_subscriptions[subscription_name] %}
{% set location = subscription.locations[location_name] %}
{% set template_tags = subscription.tags | combine(networking_tags | default({})) | combine(location.tags | default({})) %}
{% set location_code = smiths_config_metadata.locations[location_name].code %}
{% set division_code = smiths_config_metadata.divisions[template_tags.Division].code %}
{% set environment_code = smiths_config_metadata.environments[template_tags.Environment].code %}
{% set template_base = location_code ~ "-" ~ division_code ~ "-" ~ environment_code %}
{% for vnet in location.virtual_networks %}{# for vnet #}
{% set vnet_name = template_base ~ "-vnet01" %}
{% set vnet_rg = template_base ~ "-vnet-rg" %}
{% set vnet_tags = template_tags | combine(vnet.tags | default({})) %}
- name: vnet
  resource_group: {{ vnet_rg }}
  location: {{ location_name }}
  resources:
  - type: Microsoft.Network/virtualNetworks
    name: {{ vnet_name }}
    apiVersion: "2018-08-01"
    location: {{ location_name }}
    tags:
    {% for vnet_tag in (vnet_tags | dict2items) %}{# for tag #}
      {{ vnet_tag.key }}: "{{ vnet_tag.value }}"
    {% endfor %}{# endfor tag #}
    properties:
      addressSpace:
        addressPrefixes:
        {% for address_prefix in vnet.address_space %}{# for address_prefix #}
        - {{ address_prefix }}
        {% endfor %}{# endfor address_prefix #}
      dhcpOptions:
        dnsServers:
        {% for dns_server in vnet.dns_servers %}{# for dns_server #}
        - {{ dns_server }}
        {% endfor %}{# endfor dns_server #}
  {% for subnet in vnet.subnets %}{# for subnet #}
  {% set subnet_name = template_base ~ "-" ~ smiths_config_metadata.purposes[subnet.name].code ~ "-subnet01" %}
  {% set nsg_name = subnet_name ~ "-nsg" %}
  {% set route_table_name = subnet_name ~ "-route" %}
  {% set nsgRef = "[concat('/subscriptions/" ~ subscription.subscription_id ~ "/resourceGroups/" ~ vnet_rg ~ "/providers/', reference('" ~ nsg_name ~ "', '2018-08-01', 'Full').resourceId)]" %}
  {% set routeTableRef = "[concat('/subscriptions/" ~ subscription.subscription_id ~ "/resourceGroups/" ~ vnet_rg ~ "/providers/', reference('" ~ route_table_name ~ "', '2018-08-01', 'Full').resourceId)]" %}
  - type: Microsoft.Network/virtualNetworks/subnets
    name: {{ vnet_name }}/{{ subnet_name }}
    apiVersion: "2018-08-01"
    location: {{ location_name }}
    dependsOn:
    - {{ vnet_name }}
    - {{ nsg_name }}
    - {{ route_table_name }}
    properties:
      addressPrefix: {{ subnet.address_prefix }}
      networkSecurityGroup:
        id: "[resourceId('Microsoft.Network/networkSecurityGroups', '{{ nsg_name }}')]"
      routeTable:
        id: "[resourceId('Microsoft.Network/routeTables', '{{ route_table_name }}')]"
  - type: Microsoft.Network/networkSecurityGroups
    name: {{ nsg_name }}
    apiVersion: "2018-08-01"
    location: {{ location_name }}
    tags:
    {% for vnet_tag in (vnet_tags | dict2items) %}{# for vnet_tag #}
      {{ vnet_tag.key }}: "{{ vnet_tag.value }}"
    {% endfor %}{# endfor vnet_tag #}
  - type: Microsoft.Network/networkSecurityGroups/providers/diagnosticSettings
    name: {{ nsg_name }}/microsoft.insights/{{ nsg_name }}-diag01
    apiVersion: "2017-05-01-preview"
    dependsOn:
    - {{ nsg_name }}
    properties:
      logs:
      - category: NetworkSecurityGroupEvent
        enabled: true
        retentionPolicy:
          days: 90
          enabled: true
      - category: NetworkSecurityGroupRuleCounter
        enabled: true
        retentionPolicy:
          days: 90
          enabled: true
      metrics: []
      workspaceId: /subscriptions/823c312b-c266-4f6b-a93e-4b71bf0af10e/resourcegroups/zna3-bis-prd-logging-rg/providers/microsoft.operationalinsights/workspaces/zna3-bis-prd-log01
  - type: Microsoft.network/routeTables
    name: {{ route_table_name }}
    apiVersion: "2018-08-01"
    location: {{ location_name }}
    tags:
    {% for vnet_tag in (vnet_tags | dict2items) %}{# for vnet_tag #}
      {{ vnet_tag.key }}: "{{ vnet_tag.value }}"
    {% endfor %}{# endfor vnet_tag #}
  {% endfor %}{# endfor subnet #}
{% endfor %}{# endfor vnet #}

# Deploy network watcher
{% set nw_rg = template_base ~ "-nw-rg" %}
{% set nw_name = template_base ~ "-nw01" %}
{% set nw_tags = template_tags | combine(location.network_watcher.tags | default({})) %}
- name: network-watcher
  resource_group: {{ nw_rg }}
  location: {{ location_name }}
  resources:
  - type: Microsoft.Network/networkWatchers
    name: {{ nw_name }}
    apiVersion: "2018-08-01"
    location: {{ location_name }}
    tags:
    {% for nw_tag in (nw_tags | dict2items) %}{# for nw_tag #}
      {{ nw_tag.key }}: "{{ nw_tag.value }}"
    {% endfor%}{# endfor nw_tag #}
